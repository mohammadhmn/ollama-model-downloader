<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@200;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>ابزار دانلود مدل Ollama</title>
    <style>
        body {
            font-family: 'Vazirmatn', 'Segoe UI', sans-serif;
        }
    </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-50">
    <div class="flex min-h-screen items-center justify-center px-4 py-10">
        <div class="w-full max-w-6xl rounded-2xl border border-slate-700/60 bg-slate-900/70 shadow-2xl backdrop-blur-lg">
            <div class="flex flex-col lg:flex-row">
                <aside class="w-full lg:w-60 border-b border-slate-800 lg:border-b-0 lg:border-r border-dashed border-slate-800/80 bg-slate-900/40 p-6 space-y-6">
                    <div>
                        <h2 class="text-sm font-semibold uppercase tracking-[0.3em] text-slate-400">وضعیت ابزار</h2>
                        <p class="mt-2 text-xs text-slate-400 leading-relaxed">تمام اتفاقات اینجا ثبت می‌شوند.</p>
                    </div>
                    <div class="space-y-4">
                        <div class="rounded-xl border border-slate-800 bg-slate-950/80 p-4">
                            <p class="text-[0.7rem] text-slate-400">دانلودهای کامل‌شده</p>
                            <p class="text-2xl font-semibold text-emerald-400">{{len .Downloads}}</p>
                        </div>
                        <div class="rounded-xl border border-slate-800 bg-slate-950/80 p-4">
                            <p class="text-[0.7rem] text-slate-400">حالت جاری</p>
                            {{if .RunningSession}}
                            <p class="text-lg font-semibold text-sky-300">{{.RunningSession.StateLabel}}</p>
                            {{else}}
                            <p class="text-lg font-semibold text-slate-400">آماده به کار</p>
                            {{end}}
                        </div>
                        <div class="rounded-xl border border-slate-800 bg-slate-950/80 p-4">
                            <p class="text-[0.7rem] text-slate-400">مکث</p>
                            <p class="text-lg font-semibold text-amber-300">{{len .PausedSessions}}</p>
                        </div>
                        <div class="rounded-xl border border-slate-800 bg-slate-950/80 p-4">
                            <p class="text-[0.7rem] text-slate-400">خطا</p>
                            <p class="text-lg font-semibold text-rose-400">{{len .ErroredSessions}}</p>
                        </div>
                    </div>
                </aside>

                <main class="flex-1 px-6 py-6 lg:py-8 space-y-6">
                    <header class="flex flex-col gap-4">
                        <div>
                            <p class="text-xs uppercase tracking-[0.4em] text-slate-500">Ollama Model Downloader</p>
                            <h1 class="text-3xl font-bold text-white sm:text-4xl">ابزار دانلود مدل</h1>
                        </div>
                        {{if .Message}}
                        <div class="rounded-xl border border-slate-800 bg-slate-800/80 px-4 py-3 text-sm text-slate-200">{{.Message}}</div>
                        {{end}}
                    </header>

                    <section class="grid gap-6 lg:grid-cols-2">
                        <article class="rounded-2xl border border-slate-800/60 bg-gradient-to-br from-slate-900/90 to-slate-900/40 p-5 shadow-inner">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs uppercase tracking-[0.3em] text-slate-400">دانلود فعال</p>
                                    {{if .RunningSession}}
                                    <h2 class="mt-2 text-xl font-semibold text-white">{{.RunningSession.Model}}</h2>
                                    <p class="text-sm text-slate-400">{{.RunningSession.StateLabel}} · بروزرسانی {{.RunningSession.Updated}}</p>
                                    {{else}}
                                    <h2 class="mt-2 text-xl font-semibold text-slate-300">هیچ دانلود فعالی نیست</h2>
                                    {{end}}
                                </div>
                                <span class="rounded-full border border-slate-700 px-3 py-1 text-xs text-slate-400">{{if .RunningSession}}{{.RunningSession.StateLabel}}{{else}}منتظر{{end}}</span>
                            </div>
                            <div id="progressContainer" class="mt-6 hidden flex-col gap-2">
                                <progress id="progressBar" max="100" value="0" class="w-full h-3 rounded-full bg-slate-800"></progress>
                                <p id="progressText" class="text-xs text-slate-400"></p>
                            </div>
                            {{if .RunningSession}}
                            <div class="mt-6 flex flex-wrap gap-3">
                                <button onclick="pauseDownload()" class="flex-1 rounded-full border border-amber-400 bg-amber-500/20 px-4 py-2 text-sm font-semibold text-amber-200 transition hover:bg-amber-500/40 disabled:border-slate-600 disabled:text-slate-500 disabled:bg-slate-800 disabled:hover:bg-slate-800" {{if not .RunningSession}}disabled{{end}}>وقفه</button>
                                <button onclick="cancelDownload()" class="flex-1 rounded-full border border-rose-500 bg-rose-500/20 px-4 py-2 text-sm font-semibold text-rose-200 transition hover:bg-rose-500/40 disabled:border-slate-600 disabled:text-slate-500 disabled:bg-slate-800 disabled:hover:bg-slate-800" {{if not .RunningSession}}disabled{{end}}>لغو</button>
                            </div>
                            {{end}}
                        </article>

                        <article class="rounded-2xl border border-slate-800/60 bg-slate-900/60 p-5 shadow-lg">
                            <h3 class="text-sm uppercase tracking-[0.3em] text-slate-400">لیست دانلود</h3>
                            <div class="mt-3 space-y-3">
                                {{range .Downloads}}
                                <div class="rounded-xl border border-slate-800/60 bg-slate-950/60 px-4 py-3 text-sm flex items-center justify-between">
                                    <span>{{.}}</span>
                                    <a href="/download/downloaded-models/{{.}}" class="text-xs font-semibold text-sky-300 hover:text-sky-200">دانلود</a>
                                </div>
                                {{else}}
                                <p class="text-xs text-slate-500">هیچ مدل دانلودی هنوز آماده نشده است.</p>
                                {{end}}
                            </div>
                        </article>
                    </section>

                    <section class="grid gap-6 lg:grid-cols-3">
                        <article class="rounded-2xl border border-slate-800/60 bg-slate-900/60 p-5 shadow-lg">
                            <div class="flex items-center justify-between">
                                <h4 class="text-sm font-semibold">در انتظار ادامه</h4>
                                <span class="text-xs text-slate-400">{{len .PausedSessions}}</span>
                            </div>
                            <ul class="mt-4 space-y-3">
                                {{range .PausedSessions}}
                                <li class="session-card rounded-xl border border-slate-800/60 bg-slate-950/60 p-4">
                                    <div class="flex items-center justify-between">
                                        <strong class="text-sm">{{.Model}}</strong>
                                        <span class="text-[0.65rem] uppercase tracking-[0.3em] text-amber-300">{{.StateLabel}}</span>
                                    </div>
                                    <div class="mt-2 flex items-center justify-between text-xs text-slate-400">
                                        <span>شروع {{.Started}}</span>
                                        <span>بروزرسانی {{.Updated}}</span>
                                    </div>
                                    {{if .Message}}<p class="mt-2 text-[0.7rem] text-slate-500">{{.Message}}</p>{{end}}
                                    <form action="/resume" method="post" class="mt-3">
                                        <input type="hidden" name="session" value="{{.SessionID}}">
                                        <button type="submit" class="w-full rounded-full bg-sky-600/90 px-3 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white transition hover:bg-sky-500/90">ادامه</button>
                                    </form>
                                </li>
                                {{else}}
                                <li class="text-xs text-slate-500">فعلاً هیچ موردی مکث نشده.</li>
                                {{end}}
                            </ul>
                        </article>

                        <article class="rounded-2xl border border-slate-800/60 bg-slate-900/60 p-5 shadow-lg">
                            <div class="flex items-center justify-between">
                                <h4 class="text-sm font-semibold">خطاها</h4>
                                <span class="text-xs text-red-400">{{len .ErroredSessions}}</span>
                            </div>
                            <ul class="mt-4 space-y-3">
                                {{range .ErroredSessions}}
                                <li class="session-card rounded-xl border border-rose-800/60 bg-rose-900/40 p-4">
                                    <div class="flex items-center justify-between">
                                        <strong class="text-sm text-white">{{.Model}}</strong>
                                        <span class="text-[0.6rem] uppercase tracking-[0.3em] text-rose-300">{{.StateLabel}}</span>
                                    </div>
                                    <div class="mt-2 text-xs text-slate-200">
                                        {{if .Message}}خطا: {{.Message}} · {{end}}بروزرسانی {{.Updated}}
                                    </div>
                                    <form action="/resume" method="post" class="mt-3">
                                        <input type="hidden" name="session" value="{{.SessionID}}">
                                        <button type="submit" class="w-full rounded-full bg-rose-600/90 px-3 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white transition hover:bg-rose-500/90">تلاش مجدد</button>
                                    </form>
                                </li>
                                {{else}}
                                <li class="text-xs text-slate-500">هیچ خطایی رخ نداده.</li>
                                {{end}}
                            </ul>
                        </article>

                        <article class="rounded-2xl border border-slate-800/60 bg-slate-900/60 p-5 shadow-lg form-card">
                            <h4 class="text-sm font-semibold">شروع دانلود جدید</h4>
                            <form action="/download" method="post" class="mt-4 space-y-4">
                                <div>
                                    <label class="block text-xs font-semibold uppercase tracking-[0.3em] text-slate-400" for="model">نام مدل</label>
                                    <input class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/50 px-3 py-2 text-sm text-slate-100 focus:border-sky-500 focus:outline-none" id="model" name="model" placeholder="مثال: llama3.2" required>
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold uppercase tracking-[0.3em] text-slate-400" for="concurrency">همزمانی</label>
                                    <input class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/50 px-3 py-2 text-sm text-slate-100 focus:border-sky-500 focus:outline-none" id="concurrency" name="concurrency" type="number" min="1" value="4">
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold uppercase tracking-[0.3em] text-slate-400" for="retries">تلاش مجدد</label>
                                    <input class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/50 px-3 py-2 text-sm text-slate-100 focus:border-sky-500 focus:outline-none" id="retries" name="retries" type="number" min="0" value="3">
                                </div>
                                <button class="w-full rounded-2xl bg-sky-500 px-4 py-3 text-sm font-semibold uppercase tracking-[0.3em] text-white transition hover:bg-sky-400" type="submit">شروع دانلود</button>
                            </form>
                        </article>
                    </section>
                </main>
            </div>
        </div>
    </div>

    <script>
        function cancelDownload() {
            fetch('/cancel', { method: 'POST' })
                .then(() => location.reload())
                .catch(err => console.log('Cancel error:', err));
        }

        function pauseDownload() {
            fetch('/pause', { method: 'POST' })
                .then(() => location.reload())
                .catch(err => console.log('Pause error:', err));
        }

        setInterval(() => {
            fetch('/progress')
                .then(response => response.json())
                .then(data => {
                    if (data.total > 0) {
                        document.getElementById('progressContainer').style.display = 'flex';
                        document.getElementById('progressBar').value = data.percent;
                        document.getElementById('progressText').innerText = `${formatBytes(data.done)} / ${formatBytes(data.total)} (${data.percent}%)`;
                    } else {
                        document.getElementById('progressContainer').style.display = 'none';
                    }
                })
                .catch(err => console.log('Progress fetch error:', err));
        }, 1000);

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KiB', 'MiB', 'GiB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
